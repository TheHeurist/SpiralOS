# üõ°Ô∏è Codex Provenance Guard for SpiralOS
# Validates CI provenance, CI-Watermark, and Triune Bond alignment.
# Author: Carey G. Butler / Heurist GmbH
![Codex Provenance Guard](https://github.com/TheHeurist/SpiralOS/actions/workflows/codex.guard.yaml/badge.svg)

name: üåÄ Codex Provenance Guard

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    name: Hybrid Lint Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black yamllint markdownlint-cli

      # ---------------------- PYTHON ----------------------
      - name: Lint Python
        run: |
          echo "üß© Running Python lint..."
          flake8 . --count --max-line-length=120 --statistics
          black --check . || true   # non-fatal style hint

      # ---------------------- YAML ------------------------
      - name: Lint YAML
        run: |
          echo "üß© Running YAML lint..."
          yamllint -s .

      # ---------------------- MARKDOWN --------------------
      - name: Lint Markdown
        run: |
          echo "üß© Running Markdown lint..."
          markdownlint "**/*.md" --ignore node_modules || true

      # ---------------------- CODEX -----------------------
      - name: Codex Dry-Run Lint Repair
        run: |
          echo "üåÄ Codex Dry-Run repair preview"
          chmod +x ./codex.scan ./codex.repair || true
          ./codex.scan --path . --patterns "*.py" --lint python --show-errors "IndentationError" --output lint_errors_python.json
          ./codex.repair --path . --from lint_errors_python.json --lint python --mode dry-run --show-diffs true --output lint_fixes_preview.diff
        continue-on-error: true     # prevents job failure if Codex only reports hints

      - name: Upload Codex artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-lint-preview
          path: |
            lint_errors_python.json
            lint_fixes_preview.diff
