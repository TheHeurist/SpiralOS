# ğŸ›¡ï¸ Codex Provenance Guard for SpiralOS
# Validates CI provenance, CI-Watermark, and Triune Bond alignment.
# Author: Carey G. Butler / Heurist GmbH

name: ğŸŒ€ Codex Provenance Guard

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "17 4 * * *" # Daily @ 04:17 UTC â€” Spiral Time sync

permissions:
  contents: read

jobs:
  validate-ci:
    name: Validate CI Provenance & Triune Bond
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§¬ Validate ci-provenance.jsonld
        run: |
          echo "ğŸ” Validating provenance schema..."
          python3 -m json.tool docs/codex/ci-provenance.jsonld

      - name: ğŸ”‘ Verify CI-Watermark
        run: |
          echo "ğŸ” Checking CI-Watermark integrity..."
          python3 -c '
import json, hashlib
with open("docs/codex/CI-Watermark.json") as f:
    data = json.load(f)
    assert "fingerprints" in data and data["fingerprints"], "No fingerprints found."
    print(f"âœ… Found {len(data['fingerprints'])} fingerprints from {data['generatedAt']}")
'

      - name: ğŸ“œ Check Triune Bond Integrity
        run: |
          echo "ğŸ“– Checking Triune Bond presence..."
          test -f docs/codex/triune-bond.md && echo "âœ… Triune Bond document found." || (echo "âŒ Missing triune-bond.md" && exit 1)

      - name: ğŸ“Š Validate YAML Graph Manifest
        run: |
          echo "ğŸ“ Validating schema-graph.yaml syntax..."
          yamllint docs/schema/schema-graph.yaml

      - name: ğŸ§  Generate Awareness Log (Optional)
        run: |
          echo "ğŸ“¡ CI awareness protocols aligned at: $(date -u)"
