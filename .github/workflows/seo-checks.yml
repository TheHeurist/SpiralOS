name: SEO Checks
on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "23 3 * * *"   # 03:23 UTC daily

permissions:
  contents: write

jobs:
  sitemap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate sitemap (static repo fallback)
        run: |
          python - << 'PY'
            import os, time
            base = os.getenv("BASE_URL","https://theheurist.github.io/SpiralOS").rstrip("/")
            paths = []
            for root,_,files in os.walk("."):
                for f in files:
                    if f.lower().endswith((".md",".html")) and ".github" not in root:
                        p = os.path.join(root,f).lstrip("./")
                    if p.endswith(".md"):
                        p = p[:-3] + ".html"
                    paths.append(p.replace("\\","/"))
                    urls = "\n".join(f"  <url><loc>{base}/{p}</loc></url>" for p in sorted(set(paths)))
                    print("""<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n%s\n</urlset>"""%urls)
                    PY > sitemap.xml

      - name: Commit sitemap.xml if changed
        run: |
          git config user.name  "seo-bot"
          git config user.email "seo-bot@users.noreply.github.com"
          git add sitemap.xml
          if git diff --cached --quiet; then
            echo "No sitemap changes."
          else
            git commit -m "chore(seo): refresh sitemap.xml"
            git push
          fi

  links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Link check
        uses: lycheeverse/lychee-action@v1
        with:
          args: --accept 200,206,302 --max-redirects 5 --exclude-mail './**'
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
